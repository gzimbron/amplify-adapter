# AGENTS.md — amplify-adapter

## Project Overview

`amplify-adapter` is a [SvelteKit adapter](https://kit.svelte.dev/docs/adapters) that packages SvelteKit apps for deployment on AWS Amplify Hosting with SSR (Server-Side Rendering) support via CI/CD.

It is based on `@sveltejs/adapter-node` but adapted to meet Amplify's compute infrastructure requirements (deploy manifest format, directory structure, artifact limits).

**Key constraint:** Amplify enforces a **200 MB artifact size limit**.

---

## Repository Structure

```
amplify-adapter/
├── src/                    # Source files (compiled into files/ by rolldown)
│   ├── index.js            # HTTP server entry point (polka)
│   ├── handler.js          # Request handler: static, prerendered, SSR
│   ├── env.js              # Env var reader with optional prefix support
│   └── shims.js            # Node.js polyfills (optional)
├── files/                  # Built output of src/ (generated, gitignored)
├── index.js                # Main adapter entry point (used by svelte.config.js)
├── index.d.ts              # TypeScript types
├── rolldown.config.js      # Builds src/ → files/
├── package.json
└── tests/
    └── smoke.spec.js
```

---

## How the Adapter Works

When the SvelteKit user runs `vite build`, the adapter's `adapt()` function (in `index.js`) is called. It:

1. **Copies static assets** → `build/static/`
2. **Copies prerendered pages** → `build/compute/default/prerendered/`
3. **Bundles the SvelteKit server** using `rolldown` → `build/compute/default/server/`
4. **Copies runtime files** (`index.js`, `handler.js`, `env.js`, `shims.js`) from `files/` → `build/compute/default/`
5. **Writes `deploy-manifest.json`** → `build/deploy-manifest.json`

The `deploy-manifest.json` tells Amplify:
- Static files (`/*.*`) are served from the `Static` target with cache headers
- All other routes (`/*`) are handled by the Node.js compute function (`nodejs20.x`)

---

## Adapter Options

| Option | Default | Description |
|---|---|---|
| `out` | `'build'` | Output directory |
| `precompress` | `false` | Pre-compress assets with gzip/brotli |
| `envPrefix` | `''` | Prefix for environment variables |
| `polyfill` | `true` | Include Node.js polyfills |
| `copyDevNodeModules` | `false` | Copy all `node_modules` to build |
| `cleanPackageJson` | `true` | Strip `devDependencies` and `scripts` from output `package.json` |
| `keepPackageDependencies` | `false` | Keep `dependencies` in bundled output (external to the bundle) |
| `copyNpmrc` | `true` | Copy `.npmrc` to compute directory |
| `staticCacheMaxAge` | `3600` | `Cache-Control` max-age for static files (seconds) |

---

## Runtime Environment Variables

All variables support an optional prefix set via `envPrefix` adapter option.

| Variable | Default | Description |
|---|---|---|
| `HOST` | `0.0.0.0` | Server host |
| `PORT` | `3000` | Server port |
| `SOCKET_PATH` | — | Unix socket path (overrides host/port) |
| `ORIGIN` | — | App origin URL |
| `ADDRESS_HEADER` | — | Header to read client IP from |
| `XFF_DEPTH` | `1` | Depth in `x-forwarded-for` chain |
| `PROTOCOL_HEADER` | — | Header for protocol detection |
| `HOST_HEADER` | `host` | Header for host detection |
| `BODY_SIZE_LIMIT` | `524288` | Max request body size in bytes |

---

## Development Workflow

**Requirements:** Node.js 20+, pnpm

```bash
# Install dependencies
pnpm install

# Build the adapter (src/ → files/)
pnpm build

# Watch mode during development
pnpm dev

# Lint check
pnpm lint

# Auto-format
pnpm format
```

**Enable git hooks** (runs lint before commit):
```bash
git config core.hookspath .githooks
```

---

## Releasing

This project uses [Changesets](https://github.com/changesets/changesets) for versioning.

```bash
# Document a change (required for changelog)
pnpm changeset

# Publish to npm (done via CI)
pnpm release
```

Releases are automated via GitHub Actions (`.github/workflows/release.yml`). A Changesets PR is auto-created/updated on merges to `main`, and publishing happens when that PR is merged.

---

## CI

`.github/workflows/ci.yml` runs on every PR:
1. Install dependencies (`pnpm install`)
2. Lint (`pnpm lint`)
3. Build (`pnpm build`)

---

## Important Notes for Agents

- **Do not edit `files/`** — it is generated by `pnpm build`. Edit `src/` instead.
- The adapter entry point is `index.js` (root), not `src/index.js`. The root `index.js` is the SvelteKit adapter factory; `src/index.js` is the runtime HTTP server.
- Template placeholders like `HANDLER`, `SERVER`, `MANIFEST`, `ENV`, `SHIMS`, `ENV_PREFIX` in `src/` files are replaced at build time via `builder.copy()` replacements.
- The `rolldown` dependency in `package.json` is a **runtime dependency** (used inside `index.js` during `adapt()`), not just a dev dependency.
- When updating `staticCacheMaxAge` or routing rules, the `deploy-manifest.json` shape must remain valid for Amplify's hosting compute spec.
